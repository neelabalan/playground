#!/bin/bash

set -e

get_vscode_version() {
    CODE_PATH=$(which code 2>/dev/null)
    if [ -n "$CODE_PATH" ]; then
        COMMIT=$("$CODE_PATH" --version 2>/dev/null | sed -n '2p')
        if [ -n "$COMMIT" ]; then
            echo "$COMMIT"
            return 0
        fi
    fi
    
    echo "latest"
}

get_arch() {
    UNAME_ARCH=$(uname -m)
    case "$UNAME_ARCH" in
        x86_64)
            echo "x64"
            ;;
        aarch64|arm64)
            echo "arm64"
            ;;
        *)
            echo "x64"
            ;;
    esac
}

ARCH=${1:-$(get_arch)}
VSCODE_VERSION=$(get_vscode_version)

case "$ARCH" in
    x64|x86_64|amd64)
        ARCH="x64"
        PLATFORM="linux/amd64"
        ;;
    arm64|aarch64|aarch)
        ARCH="arm64"
        PLATFORM="linux/arm64"
        ;;
    *)
        echo "unsupported architecture: $ARCH"
        exit 1
        ;;
esac

echo "building VS Code server Docker image with version: $VSCODE_VERSION for architecture: $ARCH"

docker build \
    --build-arg VSCODE_SERVER_VERSION="$VSCODE_VERSION" \
    --build-arg ARCH="$ARCH" \
    --platform "$PLATFORM" \
    -t vscode-server:latest \
    -t "vscode-server:$VSCODE_VERSION" \
    -t "vscode-server:$VSCODE_VERSION-$ARCH" \
    .

echo "build complete!"
echo "image tags:"
echo "  - vscode-server:latest"
echo "  - vscode-server:$VSCODE_VERSION"
echo "  - vscode-server:$VSCODE_VERSION-$ARCH"
